user www-data;
worker_processes auto;
pid /run/nginx.pid;
error_log /var/log/nginx/error.log;
include /etc/nginx/modules-enabled/*.conf;

events {
	worker_connections 768;
}

http {

	##
	# Basic Settings
	##

	sendfile on;
	tcp_nopush on;
	types_hash_max_size 2048;

	# 10 MB shared zone, 5 requests per second per IP 
	limit_req_zone $binary_remote_addr zone=per_ip:10m rate=5r/s;
	# limit concurrent connections per IP 
	limit_conn_zone $binary_remote_addr zone=per_ip_conn:10m;

	include /etc/nginx/mime.types;
	default_type application/octet-stream;


	##
	# Logging Settings
	##

	access_log /var/log/nginx/access.log;

	##
	# Gzip Settings
	##

	gzip off;

	##
	# Virtual Host Configs
	##

	include /etc/nginx/conf.d/*.conf;
	

	server  { 
		include /etc/nginx/secrets/ollama_token.conf;
		listen 443 ssl;

		server_name ollama.local;

		# rate limits
		limit_req zone=per_ip burst=10 nodelay;
		limit_conn per_ip_conn 20;
		client_max_body_size 5m;

		ssl_certificate /etc/nginx/ssl/selfsigned.crt;
		ssl_certificate_key /etc/nginx/ssl/selfsigned.key;
		ssl_dhparam /etc/nginx/ssl/dhparam.pem;
		ssl_protocols TLSv1.3;
		ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384;
		ssl_prefer_server_ciphers on;

		# Security headers (optional but recommended) 
		add_header X-Frame-Options DENY;
		add_header X-Content-Type-Options nosniff;
		add_header X-XSS-Protection "1; mode=block";

		
		if ($http_authorization != $OLLAMA_API_TOKEN) {
			return 401;
		}

		location /ollama/ {
			proxy_pass http://localhost:11434/;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
		}

		root /var/www/html;
		index index.html;
	}

}
